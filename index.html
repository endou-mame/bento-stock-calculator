<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¼å½“ åœ¨åº«ç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-light: #E8F5E9;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --safe-color: #4CAF50;
            --border-color: #e0e0e0;
            --bg-color: #f9f9f9;
            --card-bg: white;
            --text-color: #333;
            --text-secondary: #666;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 16px;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin: 16px 0 24px 0;
            font-size: 24px;
        }

        .stock-cards {
            margin-bottom: 24px;
        }

        .stock-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }

        .delete-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 50%;
            z-index: 10;
        }

        .delete-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .card-content {
            padding: 16px;
        }

        .form-group {
            margin-bottom: 16px;
            position: relative;
        }

        .form-group:last-of-type {
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }

        input[type="date"] {
            appearance: none;
            -webkit-appearance: none;
            background-color: white;
        }

        .results {
            margin-top: 16px;
            background-color: var(--primary-light);
            border-radius: 0 0 12px 12px;
            padding: 16px;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .result-value {
            font-size: 18px;
            font-weight: 600;
        }

        .result-value.danger {
            color: var(--danger-color);
        }

        .result-value.warning {
            color: var(--warning-color);
        }

        .result-value.safe {
            color: var(--safe-color);
        }

        .result-note {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: -8px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: block;
            text-align: center;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .btn-outline:hover {
            background-color: rgba(76, 175, 80, 0.1);
        }

        .add-new {
            margin-bottom: 24px;
        }

        .empty-state {
            text-align: center;
            padding: 32px 16px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .empty-state-icon {
            font-size: 48px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .empty-state-text {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .footer {
            text-align: center;
            padding: 16px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å‘ã‘èª¿æ•´ */
        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }

            h1 {
                font-size: 22px;
            }

            .card-content {
                padding: 14px;
            }

            input {
                font-size: 16px; /* iOSã§è‡ªå‹•ã‚ºãƒ¼ãƒ ã‚’é˜²ããŸã‚ */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>åœ¨åº«ç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>

        <div id="stockCards" class="stock-cards">
            <!-- åœ¨åº«ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">ğŸ“¦</div>
            <div class="empty-state-text">åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <button class="btn" onclick="addNewStock()">åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ </button>
        </div>

        <div class="add-new" id="addNewBtn" style="display:none;">
            <button class="btn btn-outline" onclick="addNewStock()">+ æ–°ã—ã„åœ¨åº«ã‚’è¿½åŠ </button>
        </div>
    </div>

    <div class="footer">
        <p>Â© 2025 åœ¨åº«ç®¡ç†ãƒ„ãƒ¼ãƒ« by ãšã‚“ã ã‚‚ã‚“</p>
    </div>

    <script>
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
        const STORAGE_KEY = 'stockCalculatorData';

        // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—ã‚’å¿…ãšé…åˆ—ã¨ã—ã¦åˆæœŸåŒ–
        let stockItems = [];

        // æ—¥æœ¬æ™‚é–“ã®ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        function getJapanDate() {
            const now = new Date();
            // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®ã—ã¦æ—¥æœ¬æ™‚é–“ã«å¤‰æ›
            const jpTime = new Date(now.getTime() + (9 * 60 - now.getTimezoneOffset()) * 60000);
            return jpTime;
        }

        // æ—¥ä»˜ã‚’YYYY-MM-DDå½¢å¼ã«æ•´å½¢ã™ã‚‹é–¢æ•°
        function formatDateForInput(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // æ—¥ä»˜è¡¨ç¤ºç”¨ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
        function formatDateForDisplay(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}/${mm}/${dd}`;
        }

        // æ›œæ—¥ã‚’åˆ¤å®šã™ã‚‹é–¢æ•° (0:æ—¥æ›œæ—¥, 1:æœˆæ›œæ—¥, 2:ç«æ›œæ—¥, 3:æ°´æ›œæ—¥, 4:æœ¨æ›œæ—¥, 5:é‡‘æ›œæ—¥, 6:åœŸæ›œæ—¥)
        function getDayOfWeek(date) {
            return date.getDay();
        }

        // æ›œæ—¥ã‚’æ—¥æœ¬èªã®æ–‡å­—åˆ—ã§å–å¾—ã™ã‚‹é–¢æ•°
        function getDayOfWeekJP(date) {
            const days = ['æ—¥æ›œæ—¥', 'æœˆæ›œæ—¥', 'ç«æ›œæ—¥', 'æ°´æ›œæ—¥', 'æœ¨æ›œæ—¥', 'é‡‘æ›œæ—¥', 'åœŸæ›œæ—¥'];
            return days[getDayOfWeek(date)];
        }

        // æ•°å­—ã‚’æ—¥æœ¬èªã®å˜ä½ã§è¡¨ç¤ºã™ã‚‹é–¢æ•°
        function formatDaysInJapanese(days) {
            if (days === 0) return "ä»Šæ—¥";
            if (days === 1) return "æ˜æ—¥";
            if (days === 2) return "æ˜å¾Œæ—¥";
            return `${days}æ—¥å¾Œ`;
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    // å¿…ãšé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                    stockItems = Array.isArray(parsedData) ? parsedData : [];
                } else {
                    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ç©ºã®é…åˆ—ã§åˆæœŸåŒ–
                    stockItems = [];
                }
            } catch (error) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ç©ºã®é…åˆ—ã§åˆæœŸåŒ–
                stockItems = [];
                // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                localStorage.removeItem(STORAGE_KEY);
            }

            renderStockCards();
            updateEmptyState();
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveToLocalStorage() {
            try {
                // é…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                if (!Array.isArray(stockItems)) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼: stockItemsãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                    stockItems = []; // å¼·åˆ¶çš„ã«é…åˆ—åŒ–
                }
                localStorage.setItem(STORAGE_KEY, JSON.stringify(stockItems));
            } catch (error) {
                console.error('ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // åœ¨åº«ã‚«ãƒ¼ãƒ‰ã‚’æç”»ã™ã‚‹é–¢æ•°
        function renderStockCards() {
            const stockCardsContainer = document.getElementById('stockCards');
            stockCardsContainer.innerHTML = '';

            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems)) {
                console.error('æç”»ã‚¨ãƒ©ãƒ¼: stockItemsãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                stockItems = []; // å¼·åˆ¶çš„ã«é…åˆ—åŒ–
                return;
            }

            stockItems.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'stock-card';

                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteStock(${index})">Ã—</button>
                    <div class="card-content">
                        <div class="form-group">
                            <label for="name-${index}">åœ¨åº«å:</label>
                            <input type="text" id="name-${index}" value="${item.name || ''}" placeholder="å•†å“åã‚’å…¥åŠ›" oninput="updateStockName(${index}, this.value)">
                        </div>
                        <div class="form-group">
                            <label for="startDate-${index}">åŸºæº–æ—¥:</label>
                            <input type="date" id="startDate-${index}" value="${item.startDate}" oninput="updateStockData(${index})">
                        </div>
                        <div class="form-group">
                            <label for="initialStock-${index}">åˆæœŸåœ¨åº«æ•°:</label>
                            <input type="number" id="initialStock-${index}" min="0" value="${item.initialStock}" placeholder="æ•°é‡ã‚’å…¥åŠ›"
                                oninput="updateStockDataDelayed(${index}, this.value, 'initialStock')">
                        </div>
                    </div>
                    <div class="results">
                        <div class="result-row">
                            <div class="result-label">ç¾åœ¨ã®åœ¨åº«æ•°:</div>
                            <div class="result-value">${item.currentStock !== undefined ? item.currentStock : '-'}</div>
                        </div>
                        <div class="result-row">
                            <div class="result-label">åœ¨åº«åˆ‡ã‚Œäºˆæ¸¬:</div>
                            <div class="result-value ${getColorClass(item.daysUntilZero)}">${item.zeroStockDate || '-'}</div>
                        </div>
                        ${item.daysUntilZero ? `<div class="result-note">${item.daysUntilZeroText || ''}</div>` : ''}
                    </div>
                `;

                stockCardsContainer.appendChild(card);
            });

            updateEmptyState();
        }

        // é…å»¶æ›´æ–°ç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ID
        let updateTimers = {};

        // é…å»¶æ›´æ–°é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚Œã‚‹ã®ã‚’é˜²ããŸã‚ï¼‰
        function updateStockDataDelayed(index, value, field) {
            // å‰ã®ã‚¿ã‚¤ãƒãƒ¼ãŒã‚ã‚Œã°ã‚¯ãƒªã‚¢
            if (updateTimers[`${index}-${field}`]) {
                clearTimeout(updateTimers[`${index}-${field}`]);
            }

            // å€¤ã‚’å³æ™‚æ›´æ–°
            if (field === 'initialStock') {
                stockItems[index].initialStock = parseInt(value) || 0;
            }

            // é…å»¶ã—ã¦è¨ˆç®—ã¨ä¿å­˜ã‚’å®Ÿè¡Œ
            updateTimers[`${index}-${field}`] = setTimeout(() => {
                calculateStockItem(index);
                saveToLocalStorage();

                // çµæœéƒ¨åˆ†ã ã‘ã‚’æ›´æ–°
                updateResultsDisplay(index);

                // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
                delete updateTimers[`${index}-${field}`];
            }, 500); // 500mså¾Œã«å®Ÿè¡Œ
        }

        // çµæœè¡¨ç¤ºéƒ¨åˆ†ã ã‘ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateResultsDisplay(index) {
            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems) || !stockItems[index]) {
                console.error('updateResultsDisplay: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™');
                return;
            }

            const item = stockItems[index];
            const cardElement = document.querySelectorAll('.stock-card')[index];

            if (!cardElement) return;

            const resultsDiv = cardElement.querySelector('.results');
            if (resultsDiv) {
                resultsDiv.innerHTML = `
                    <div class="result-row">
                        <div class="result-label">ç¾åœ¨ã®åœ¨åº«æ•°:</div>
                        <div class="result-value">${item.currentStock !== undefined ? item.currentStock : '-'}</div>
                    </div>
                    <div class="result-row">
                        <div class="result-label">åœ¨åº«åˆ‡ã‚Œäºˆæ¸¬:</div>
                        <div class="result-value ${getColorClass(item.daysUntilZero)}">${item.zeroStockDate || '-'}</div>
                    </div>
                    ${item.daysUntilZero ? `<div class="result-note">${item.daysUntilZeroText || ''}</div>` : ''}
                `;
            }
        }

        // åœ¨åº«åˆ‡ã‚Œäºˆæ¸¬ã«åŸºã¥ã„ã¦è‰²åˆ†ã‘ã™ã‚‹ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        function getColorClass(days) {
            if (days === undefined) return '';
            if (days <= 0) return 'danger';
            if (days <= 3) return 'danger';
            if (days <= 7) return 'warning';
            return 'safe';
        }

        // ç©ºã®çŠ¶æ…‹ã‚’æ›´æ–°
        function updateEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const addNewBtn = document.getElementById('addNewBtn');

            if (!Array.isArray(stockItems) || stockItems.length === 0) {
                emptyState.style.display = 'block';
                addNewBtn.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                addNewBtn.style.display = stockItems.length < 3 ? 'block' : 'none';
            }
        }

        // æ–°ã—ã„åœ¨åº«ã‚’è¿½åŠ 
        function addNewStock() {
            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems)) {
                console.error('addNewStock: stockItemsãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                stockItems = []; // å¼·åˆ¶çš„ã«é…åˆ—åŒ–
            }

            if (stockItems.length >= 3) {
                alert('æœ€å¤§3ã¤ã¾ã§ã®åœ¨åº«ã—ã‹ç®¡ç†ã§ãã¾ã›ã‚“');
                return;
            }

            const today = getJapanDate();

            stockItems.push({
                name: '',
                startDate: formatDateForInput(today),
                initialStock: 0,
                currentStock: 0,
                zeroStockDate: '',
                daysUntilZero: 0,
                daysUntilZeroText: ''
            });

            saveToLocalStorage();
            renderStockCards();

            // æœ€æ–°ã®åœ¨åº«ã‚«ãƒ¼ãƒ‰ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                window.scrollTo({
                    top: document.body.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        function updateStockData(index) {
            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems) || !stockItems[index]) {
                console.error('updateStockData: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™');
                return;
            }

            const startDateInput = document.getElementById(`startDate-${index}`);

            const startDateStr = startDateInput.value;

            if (!startDateStr) return;

            stockItems[index].startDate = startDateStr;

            // åœ¨åº«è¨ˆç®—ã‚’å®Ÿè¡Œ
            calculateStockItem(index);

            // ä¿å­˜
            saveToLocalStorage();

            // çµæœéƒ¨åˆ†ã ã‘ã‚’æ›´æ–°
            updateResultsDisplay(index);
        }

        // åœ¨åº«åã‚’æ›´æ–°
        function updateStockName(index, name) {
            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems) || !stockItems[index]) {
                console.error('updateStockName: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™');
                return;
            }

            stockItems[index].name = name;
            saveToLocalStorage();
        }

        // åœ¨åº«ã‚’å‰Šé™¤
        function deleteStock(index) {
            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems) || !stockItems[index]) {
                console.error('deleteStock: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™');
                return;
            }

            if (confirm('ã“ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                stockItems.splice(index, 1);
                saveToLocalStorage();
                renderStockCards();
            }
        }

        // åœ¨åº«è¨ˆç®—é–¢æ•°ï¼ˆç‰¹å®šã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®åœ¨åº«ã‚¢ã‚¤ãƒ†ãƒ ç”¨ï¼‰
        function calculateStockItem(index) {
            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems) || !stockItems[index]) {
                console.error('calculateStockItem: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™');
                return;
            }

            const item = stockItems[index];

            // æ—¥ä»˜ã®å¤‰æ›
            const startDate = new Date(item.startDate);
            const currentDate = getJapanDate();

            // æ—¥ä»˜ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
            if (isNaN(startDate.getTime())) {
                return;
            }

            // åŸºæº–æ—¥ã‚’00:00:00ã«è¨­å®š
            startDate.setHours(0, 0, 0, 0);
            // ç¾åœ¨æ—¥ã‚‚00:00:00ã«è¨­å®šï¼ˆæ™‚é–“ã‚’ç„¡è¦–ã—ã¦æ—¥æ•°ã ã‘ã‚’è€ƒæ…®ï¼‰
            const todayDate = new Date(currentDate);
            todayDate.setHours(0, 0, 0, 0);

            // çµŒéæ—¥æ•°ã®è¨ˆç®—ï¼ˆåŸºæº–æ—¥ã‚’å«ã‚ãªã„ã‚ˆã†ã«èª¿æ•´ï¼‰
            const timeDiff = todayDate.getTime() - startDate.getTime();
            const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));

            let currentStock = item.initialStock;

            // åŸºæº–æ—¥ã‹ã‚‰ä»Šæ—¥ã¾ã§ã®å„æ—¥ã®åœ¨åº«æ¸›å°‘ã‚’è¨ˆç®—
            for (let i = 0; i < daysDiff; i++) { // åŸºæº–æ—¥ã‚’å«ã‚ãªã„ã‚ˆã†ã« < ã‚’ä½¿ç”¨
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i + 1); // +1 ã§åŸºæº–æ—¥ã®ç¿Œæ—¥ã‹ã‚‰è¨ˆç®—
                const dayOfWeek = getDayOfWeek(day);

                // æ°´æ›œæ—¥(3)ã¨åœŸæ›œæ—¥(6)ã¯-1ã€ãã‚Œä»¥å¤–ã¯-2
                let decrease = (dayOfWeek === 3 || dayOfWeek === 6) ? 1 : 2;
                currentStock -= decrease;

                // åœ¨åº«ãŒ0ä»¥ä¸‹ã«ãªã£ãŸã‚‰ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                if (currentStock <= 0) {
                    currentStock = 0;
                    break;
                }
            }

            // çµæœã‚’æ›´æ–°
            item.currentStock = currentStock;

            // åœ¨åº«åˆ‡ã‚Œäºˆæ¸¬æ—¥ã‚’è¨ˆç®—
            calculateZeroStockDate(index);
        }

        // åœ¨åº«åˆ‡ã‚Œäºˆæ¸¬æ—¥ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
        function calculateZeroStockDate(index) {
            // å¿µã®ãŸã‚é…åˆ—ã‹ã©ã†ã‹ç¢ºèª
            if (!Array.isArray(stockItems) || !stockItems[index]) {
                console.error('calculateZeroStockDate: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒç„¡åŠ¹ã§ã™');
                return;
            }

            const item = stockItems[index];
            const currentStock = item.currentStock;

            // æ—¢ã«åœ¨åº«åˆ‡ã‚Œã®å ´åˆ
            if (currentStock <= 0) {
                item.zeroStockDate = "åœ¨åº«åˆ‡ã‚Œ";
                item.daysUntilZero = 0;
                item.daysUntilZeroText = "";
                return;
            }

            const todayDate = getJapanDate();
            todayDate.setHours(0, 0, 0, 0);

            // ç¾åœ¨ã®æ—¥ä»˜ã‹ã‚‰é–‹å§‹
            let predictDate = new Date(todayDate);
            let remainingStock = currentStock;
            let daysUntilZero = 0;

            // äºˆæ¸¬æ—¥ä»˜ã‚’è¨ˆç®—
            while (remainingStock > 0) {
                daysUntilZero++;
                predictDate.setDate(predictDate.getDate() + 1);
                const dayOfWeek = getDayOfWeek(predictDate);

                // æ°´æ›œæ—¥(3)ã¨åœŸæ›œæ—¥(6)ã¯-1ã€ãã‚Œä»¥å¤–ã¯-2
                let decrease = (dayOfWeek === 3 || dayOfWeek === 6) ? 1 : 2;
                remainingStock -= decrease;
            }

            // çµæœã‚’æ›´æ–°
            item.zeroStockDate = formatDateForDisplay(predictDate);
            item.daysUntilZero = daysUntilZero;
            item.daysUntilZeroText = `ï¼ˆ${formatDaysInJapanese(daysUntilZero)}ï¼‰`;
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
        document.addEventListener('DOMContentLoaded', loadFromLocalStorage);
    </script>
</body>
</html>