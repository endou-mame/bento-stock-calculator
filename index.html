<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在庫計算ツール</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .container {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #4CAF50;
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background-color: #f2f2f2;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .result-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .result-value {
            font-size: 24px;
            color: #4CAF50;
        }
        .result-subtitle {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        .danger {
            color: #e74c3c;
        }
        .warning {
            color: #f39c12;
        }
        .safe {
            color: #4CAF50;
        }
        .footer {
            margin-top: 20px;
            text-align: center;
            font-size: 12px;
            color: #666;
        }
        .debug-info {
            margin-top: 20px;
            font-size: 12px;
            color: #999;
            border-top: 1px dashed #ddd;
            padding-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>在庫計算ツール</h1>
        <div class="form-group">
            <label for="startDate">基準日:</label>
            <input type="date" id="startDate" required>
        </div>
        <div class="form-group">
            <label for="initialStock">初期在庫数:</label>
            <input type="number" id="initialStock" min="0" required>
        </div>

        <div class="result-item">
            <div class="result-title">現在の在庫数:</div>
            <div class="result-value" id="resultCurrentStock">-</div>
        </div>

        <div class="result-item">
            <div class="result-title">在庫切れ予測:</div>
            <div class="result-value" id="resultZeroStockDate">-</div>
            <div class="result-subtitle" id="resultDaysUntilZero"></div>
        </div>

        <button onclick="calculateStock()">再計算</button>

        <div class="debug-info" id="debugInfo"></div>
    </div>

    <div class="footer">
        <p>© 2025 在庫計算ツール by ずんだもん</p>
    </div>

    <script>
        // ローカルストレージキー
        const STORAGE_KEY = 'stockCalculatorData';

        // 日本時間の現在の日付を取得する関数
        function getJapanDate() {
            const now = new Date();
            // タイムゾーンオフセットを考慮して日本時間に変換
            const jpTime = new Date(now.getTime() + (9 * 60 - now.getTimezoneOffset()) * 60000);
            return jpTime;
        }

        // 日付をYYYY-MM-DD形式に整形する関数
        function formatDateForInput(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        // 日付表示用にフォーマットする関数
        function formatDateForDisplay(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}/${mm}/${dd}`;
        }

        // 曜日を判定する関数 (0:日曜日, 1:月曜日, 2:火曜日, 3:水曜日, 4:木曜日, 5:金曜日, 6:土曜日)
        function getDayOfWeek(date) {
            return date.getDay();
        }

        // 曜日を日本語の文字列で取得する関数
        function getDayOfWeekJP(date) {
            const days = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];
            return days[getDayOfWeek(date)];
        }

        // 数字を日本語の単位で表示する関数
        function formatDaysInJapanese(days) {
            if (days === 0) return "今日";
            if (days === 1) return "明日";
            if (days === 2) return "明後日";
            return `${days}日後`;
        }

        // ローカルストレージからデータを読み込む
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('startDate').value = data.startDate || formatDateForInput(getJapanDate());
                document.getElementById('initialStock').value = data.initialStock || '';

                // 保存されたデータがあれば自動計算
                if (data.startDate && data.initialStock) {
                    calculateStock();
                }
            } else {
                // 初回訪問時は今日の日付を設定
                document.getElementById('startDate').value = formatDateForInput(getJapanDate());
            }
        }

        // ローカルストレージにデータを保存
        function saveToLocalStorage(startDate, initialStock) {
            const data = {
                startDate: startDate,
                initialStock: initialStock
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // 在庫計算関数
        function calculateStock() {
            // 入力値の取得
            const startDateStr = document.getElementById('startDate').value;
            const initialStock = parseInt(document.getElementById('initialStock').value);

            // 入力チェック
            if (!startDateStr || isNaN(initialStock)) {
                alert('基準日と初期在庫数を入力してください');
                return;
            }

            // ローカルストレージに保存
            saveToLocalStorage(startDateStr, initialStock);

            // 日付の変換
            const startDate = new Date(startDateStr);
            const currentDate = getJapanDate();

            // 日付が有効かチェック
            if (isNaN(startDate.getTime())) {
                alert('有効な日付を入力してください');
                return;
            }

            // 基準日を00:00:00に設定
            startDate.setHours(0, 0, 0, 0);
            // 現在日も00:00:00に設定（時間を無視して日数だけを考慮）
            const todayDate = new Date(currentDate);
            todayDate.setHours(0, 0, 0, 0);

            // 経過日数の計算（基準日も含める）
            const timeDiff = todayDate.getTime() - startDate.getTime();
            const daysDiff = Math.floor(timeDiff / (1000 * 3600 * 24));

            if (daysDiff < 0) {
                alert('基準日は今日より前の日付にしてください');
                return;
            }

            // デバッグ情報の初期化
            let debugInfo = [];
            let currentStock = initialStock;

            // 基準日から今日までの各日の在庫減少を計算
            for (let i = 0; i <= daysDiff; i++) {
                const day = new Date(startDate);
                day.setDate(startDate.getDate() + i);
                const dayOfWeek = getDayOfWeek(day);

                // 水曜日(3)と土曜日(6)は-1、それ以外は-2
                let decrease = (dayOfWeek === 3 || dayOfWeek === 6) ? 1 : 2;
                currentStock -= decrease;

                // デバッグ情報を追加
                debugInfo.push(`${formatDateForDisplay(day)} (${getDayOfWeekJP(day)}): -${decrease}, 残り${Math.max(0, currentStock)}`);

                // 在庫が0以下になったらループを抜ける
                if (currentStock <= 0) {
                    currentStock = 0;
                    break;
                }
            }

            // 結果の表示
            document.getElementById('resultCurrentStock').textContent = currentStock;

            // 在庫切れ予測日の計算
            calculateZeroStockDate(startDate, initialStock, currentStock);

            // デバッグ情報を表示（開発時に役立つ）
            const debugInfoElement = document.getElementById('debugInfo');
            debugInfoElement.innerHTML = debugInfo.join('<br>');
            // debugInfoElement.style.display = 'block'; // 必要な場合はコメントを外す
        }

        // 在庫切れ予測日を計算する関数
        function calculateZeroStockDate(startDate, initialStock, currentStock) {
            // 既に在庫切れの場合
            if (currentStock <= 0) {
                document.getElementById('resultZeroStockDate').textContent = "在庫切れ";
                document.getElementById('resultZeroStockDate').className = "result-value danger";
                document.getElementById('resultDaysUntilZero').textContent = "";
                return;
            }

            const todayDate = getJapanDate();
            todayDate.setHours(0, 0, 0, 0);

            // 現在の日付から開始
            let predictDate = new Date(todayDate);
            let remainingStock = currentStock;
            let daysUntilZero = 0;

            // 予測日付を計算
            while (remainingStock > 0) {
                daysUntilZero++;
                predictDate.setDate(predictDate.getDate() + 1);
                const dayOfWeek = getDayOfWeek(predictDate);

                // 水曜日(3)と土曜日(6)は-1、それ以外は-2
                let decrease = (dayOfWeek === 3 || dayOfWeek === 6) ? 1 : 2;
                remainingStock -= decrease;
            }

            // 結果の表示
            document.getElementById('resultZeroStockDate').textContent = formatDateForDisplay(predictDate);

            // 日数に応じた色分け
            if (daysUntilZero <= 3) {
                document.getElementById('resultZeroStockDate').className = "result-value danger";
            } else if (daysUntilZero <= 7) {
                document.getElementById('resultZeroStockDate').className = "result-value warning";
            } else {
                document.getElementById('resultZeroStockDate').className = "result-value safe";
            }

            // 残り日数の表示
            document.getElementById('resultDaysUntilZero').textContent = `（${formatDaysInJapanese(daysUntilZero)}）`;
        }

        // ページ読み込み時にローカルストレージから復元
        document.addEventListener('DOMContentLoaded', loadFromLocalStorage);
    </script>
</body>
</html>